{% extends "base.html" %}

<!--头部-->
{% block title %} secrets节点 {% endblock %}
<!-停留的样式-->
<!--layui-nav-itemed 为开关-->
{% block nav-item-4 %} layui-nav-itemed {% endblock %}

<!--layui-this 停留的背景颜色-->
{% block nav-this-5-1 %}layui-this {% endblock %}

<!--内容-->
{% block content %}
    <div class="layui-card">
        <div class="layui-card-body">
            <table id="demo" lay-filter="test"></table>
        </div>
    </div>
{% endblock %}

<!--js代码-->
{% block js %}
    <script type="text/html" id="toolbarDemo">
        <!--增加一个输入框-->
        <input type="text" name="name" class="layui-input" style="width: 150px;height: 30px;float: left">
        <button class="layui-btn layui-btn-sm" style="float: left" id="searchBtn">搜索</button>
        <button class="layui-btn layui-btn-sm" style="float: left" id="createBtn">创建</button>
    </script>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs layui-btn-primary" lay-event="edit">YAML</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
        <a class="layui-btn layui-btn-xs" lay-event="preview">预览</a>
    </script>

    <script>
    layui.use(['table', 'layer'], function () {
    var table = layui.table;
    var layer = layui.layer;
    var $ = layui.jquery;

    table.render({
        elem: '#demo',
        url: '{% url "files:files_api" %}',
        toolbar: '#toolbarDemo',
        title: '数据表',
        skin: 'line',
        cols: [[
            {field: 'name', title: '文件名称', sort: true},
            {fixed: 'right', title: '操作', toolbar: '#barDemo', width: 150}
        ]],
        page: true,
        id: "se",
        parseData: function(res) {
            console.log('Response from server:', res);
            return {
                "code": res.code,
                "msg": res.msg,
                "count": res.count,
                "data": [res.data]
            };
        },
        done: function(res, curr, count) {
            console.log('Table render complete:', res);
        }
    });

    table.on('tool(test)', function (obj) {
        var data = obj.data;
        if (obj.event === 'preview') {
            $.ajax({
                type: "GET",
                url: "preview",
                data: {name: data.name},
                success: function (res) {
                    if (res.code == 200) {
                        layer.open({
                            type: 1,
                            title: '文件预览',
                            area: ['600px', '400px'],
                            content: '<pre style="padding: 10px;">' + res.content + '</pre>'
                        });
                    } else {
                        layer.msg(res.msg, {icon: 5});
                    }
                },
                error: function () {
                    layer.msg("服务器接口异常！", {icon: 5});
                }
            });
        } else if (obj.event === 'del') {
            layer.confirm('是否确定删除' + data["name"] + "这个文件吗？", function (index) {
                $.ajax({
                    type: "DELETE",
                    url: "{% url 'storage:secrets_api' %}",
                    data: {name: data.name},
                    headers: {"X-CSRFToken": $('[name="csrfmiddlewaretoken"]').val()},
                    success: function (res) {
                        if (res.code == 0) {
                            layer.msg(res.msg, {icon: 6});
                            obj.del();
                        } else {
                            layer.msg(res.msg, {icon: 5});
                        }
                    },
                    error: function () {
                        layer.msg("服务器接口异常！", {icon: 5});
                    }
                });
            });
        } else if (obj.event === 'edit') {
            layer.open({
                title: 'YAML',
                type: 2,
                area: ['50%', '60%'],
                content: "{% url 'ace_editor' %}?resource=secrets&" + 'namespace=' + data['namespace'] + '&name=' + data['name'],
            });
        }
    });

    $(document).on('click', '#searchBtn', function () {
        var input_val = $('input[name=name]').val();
        if (!input_val) {
            console.log("为空");
            window.parent.location.reload();
        } else {
            table.reload('se', {
                where: {
                    searchkey: input_val
                },
                page: {
                    curr: 1
                }
            });
        }
    });
});

    </script>
{% endblock %}
