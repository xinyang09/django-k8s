{% extends 'base.html' %}
{% block title %}ingress{% endblock %}
{% block nav-item-3 %}layui-nav-itemed{% endblock %}
{% block nav-this-3-2 %}layui-this{% endblock %}
{% block content %}
<span class="layui-breadcrumb">
  <a href="#">首页</a>
  <a href="#">ingress</a>
  <a><cite>create</cite></a>
</span>
<hr>

<div class="layui-card">
    <div class="layui-card-body">

    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
      <legend>创建ingress</legend>
    </fieldset>

    <form class="layui-form" id="ingressForm">
        {% csrf_token %}
        <div class="layui-form-item">
            <label class="layui-form-label">名称：</label>
            <div class="layui-input-block">
              <input type="text" name="name" lay-verify="required" lay-reqtext="名称是必填项，不能为空！" placeholder="" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">命名空间：</label>
            <div class="layui-input-block">
                <select name="namespace" lay-verify="required" id="ns">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
         </div>

        <div class="layui-form-item">
            <label class="layui-form-label">host：</label>
            <div class="layui-input-block">
              <input type="text" name="host" lay-verify="required" lay-reqtext="名称是必填项，不能为空！" placeholder="" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">path：</label>
            <div class="layui-input-block">
              <input type="text" name="path" lay-verify="required" lay-reqtext="名称是必填项，不能为空！" placeholder="" autocomplete="off" class="layui-input">
            </div>
        </div>

        <label class="layui-form-label">关联service：</label>
        <div class="layui-input-block">
            <select id="service-select" name="selector" lay-verify="required" lay-reqtext="名称是必填项，不能为空！" class="layui-input">
                <option value="">请选择一个服务</option>
            </select>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">ServicePort：</label>
            <div class="layui-input-block">
              <input type="text" name="port" lay-verify="required" lay-reqtext="名称是必填项，不能为空！" placeholder="" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">标签：</label>
            <div class="layui-input-block">
              <input type="text" name="labels" lay-verify="required" lay-reqtext="标签是必填项，不能为空！" placeholder="示例: project=ms,app=gateway" autocomplete="off" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
              <button type="button" class="layui-btn" id="submitBtn">立即提交</button>
              <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>

    </div>
</div>

{% endblock %}

{% block js %}
<script>
layui.use(['form'], function(){
  var form = layui.form;
  var $ = layui.jquery;

  // Populate the namespace select dynamically
  var namespace = window.sessionStorage.getItem("namespace");
  if (namespace) {
    $('#ns').append('<option value="' + namespace + '">' + namespace + '</option>');
    form.render('select');  // Re-render the select element
  }

  // Populate the services select dynamically
  window.onload = function() {
    // 使用 AJAX 请求获取服务数据
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/loadbalancer/services_api/?namespace=default&page=1&limit=10", true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var response = JSON.parse(xhr.responseText);
        var services = response.data;  // 假设返回的 JSON 数据中包含一个名为 data 的数组
        var select = document.getElementById("service-select");

        // 遍历服务数据并动态添加选项到下拉选择框
        services.forEach(function(service) {
          var option = document.createElement("option");
          option.text = service.name;
          option.value = service.name;  // 使用服务的名称作为值
          select.appendChild(option);
        });

        // 重新渲染 select 元素
        form.render('select');
      }
    };
    xhr.send();
  };

  $('#submitBtn').click(function () {
    var formData = {
        name: $('input[name="name"]').val(),
        namespace: $('select[name="namespace"]').val(),
        selector: $('select[name="selector"]').val(),
        labels: $('input[name="labels"]').val(),
        port: $('input[name="port"]').val(),
        path: $('input[name="path"]').val(),
        host: $('input[name="host"]').val()

    };

    var datajson = JSON.stringify(formData);

    $.ajax({
        url: '{% url "loadbalancer:ingresses_create" %}',
        type: "POST",
        contentType: 'application/json',
        headers: { 'X-CSRFToken': $('[name="csrfmiddlewaretoken"]').val() },
        data: datajson,
        dataType: 'json',
        success: function (res) {
            if (res.code == 0) {
                layer.msg(res.msg, {icon: 6});
                window.location.href = "{% url 'loadbalancer:ingresses' %}";
            } else {
                layer.msg(res.msg, {icon: 5});
            }
        },
        error: function (xhr) {
            layer.msg("服务器接口异常", {icon: 5});
            console.log(xhr.responseText);
        }
    });

    return false;  // 阻止表单的默认提交行为
  });
});
</script>
{% endblock %}
